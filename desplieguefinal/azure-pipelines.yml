# ASP.NET Core 9 - Build & Publish

# Para cuentas gratis de App Service usar --runtime win-x86

trigger:
- main

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  proyecto: 'desplieguefinal/desplieguefinal.csproj'
  solucion: 'desplieguefinal.sln'

steps:
- task: UseDotNet@2
  displayName: 'Instalar .NET SDK 9'
  inputs:
    packageType: 'sdk'
    # Usa siempre la última 9.0.x disponible en el agente
    version: '9.0.x'
    includePreviewVersions: false

- script: dotnet --info
  displayName: 'Información de .NET'

- script: dotnet restore $(solucion)
  displayName: 'dotnet restore'

- script: dotnet build --configuration $(buildConfiguration) $(solucion) --no-restore
  displayName: 'dotnet build $(buildConfiguration)'

# Tareas de Entity Framework Core (opcionales - descomentar si usas EF Core)
# - task: CmdLine@2
#   displayName: 'Instalar EF Core CLI 9'
#   inputs:
#     script: |
#       dotnet tool install --global dotnet-ef --version 9.*
#   env:
#     PATH: $(PATH);$(USERPROFILE)\.dotnet\tools

# - task: CmdLine@2
#   displayName: 'Generar script de BD'
#   inputs:
#     script: |
#       dotnet ef migrations script -i -o "$(Build.ArtifactStagingDirectory)\migrate.sql" --project "$(proyecto)"

- task: DotNetCoreCLI@2
  displayName: 'Publicar aplicación'
  inputs:
    command: 'publish'
    publishWebProjects: false
    projects: '$(proyecto)'
    arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory) --runtime win-x86 --self-contained true'
    zipAfterPublish: false
    modifyOutputPath: false

- task: PublishBuildArtifacts@1
  displayName: 'Publicar artefactos'
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'drop'
    publishLocation: 'Container'

